<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Appointments - Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="icon" href="./assets/images/logo/favicon.png" />

  <!-- CSS -->
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/variables.css">
  <link rel="stylesheet" href="./css/base.css">
  <link rel="stylesheet" href="./css/components.css">
  <link rel="stylesheet" href="./css/layout.css">
  <link rel="stylesheet" href="./css/dashboards.css">
  <link rel="stylesheet" href="./css/themes.css">
  <link rel="stylesheet" href="./css/responsive.css">
  <link rel="stylesheet" href="./css/utilities.css">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div class="dashboard-container">

  <!-- Sidebar -->
  <aside class="dashboard-sidebar" id="adminSidebar"></aside>

  <!-- Main -->
  <main class="dashboard-main">
    <header class="dashboard-header">
      <h1 class="dashboard-title">Appointments</h1>
      <div class="dashboard-actions">
        <button class="btn btn-outline-primary" id="refreshAppointments">
          <i class="fas fa-rotate"></i> Refresh
        </button>
      </div>
    </header>

    <section class="dashboard-content">

      <!-- Appointments Table -->
      <div class="dashboard-card">
        <div class="dashboard-card-header">
          <h3>All Appointments</h3>
        </div>
        <div class="dashboard-card-body" id="appointmentsTable">
          <!-- JS inject -->
        </div>
      </div>

    </section>
  </main>

</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>

<script src="./js/config/supabase.js" defer></script>
<script src="./js/config/constants.js" defer></script>
<script src="./js/utils/helpers.js" defer></script>
<script src="./js/utils/date-utils.js" defer></script>
<script src="./js/utils/toast.js" defer></script>
<script src="./js/core/auth.js" defer></script>
<script src="./js/core/theme.js" defer></script>
<script src="./js/components/loader.js" defer></script>

<!-- Page JS -->
<script src="./js/dashboards/admin/index.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Refresh button
  document.getElementById('refreshAppointments')?.addEventListener('click', loadAppointmentsTable);
  
  // Load appointments table
  loadAppointmentsTable();
});

// Load all appointments into table
async function loadAppointmentsTable() {
  const container = document.getElementById('appointmentsTable');
  if (!container) return;

  loader.showSectionLoader(container);

  try {
    const { data, error } = await supabaseClient
      .from('appointments')
      .select(`
        booking_id,
        appointment_date,
        status,
        profiles(full_name),
        doctor:doctors(name)
      `)
      .order('appointment_date', { ascending: false });

    if (error) throw error;

    if (!data.length) {
      container.innerHTML = `<p class="text-muted">No appointments found</p>`;
      return;
    }

    container.innerHTML = `
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Patient</th>
            <th>Doctor</th>
            <th>Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${data.map(a => `
            <tr>
              <td>${a.booking_id}</td>
              <td>${a.profiles?.full_name || '-'}</td>
              <td>${a.doctor?.name || '-'}</td>
              <td>${helpers.formatDate(a.appointment_date)}</td>
              <td><span class="badge bg-primary">${a.status}</span></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch(err) {
    toast.error('Failed to load appointments');
  }

  loader.hideSectionLoader(container);
}
</script>

</body>
</html>
