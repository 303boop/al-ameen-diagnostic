<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Logs - Admin Dashboard</title>

    <link rel="icon" href="../../assets/images/logo/logo.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/variables.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/layout.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/dashboards.css">
    <link rel="stylesheet" href="../../css/themes.css">
    <link rel="stylesheet" href="../../css/utilities.css">
</head>

<body>
    <div class="dashboard-container">

        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <a href="../../index.html" class="sidebar-logo text-decoration-none">
                    <img src="../../assets/images/logo/logo.png" alt="Logo">
                    <span class="text-white ms-2">Admin Panel</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-label">Overview</div>
                <a href="./index.html" class="sidebar-nav-item">
                    <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
                </a>
                <a href="./analytics.html" class="sidebar-nav-item">
                    <i class="fas fa-chart-line"></i><span>Analytics</span>
                </a>

                <div class="nav-label">Management</div>
                <a href="./appointments.html" class="sidebar-nav-item">
                    <i class="fas fa-calendar-check"></i><span>Appointments</span>
                </a>
                <a href="./doctors.html" class="sidebar-nav-item">
                    <i class="fas fa-user-md"></i><span>Doctors</span>
                </a>
                <a href="./tests.html" class="sidebar-nav-item">
                    <i class="fas fa-microscope"></i><span>Lab Tests</span>
                </a>
                <a href="./users.html" class="sidebar-nav-item">
                    <i class="fas fa-users"></i><span>Patients</span>
                </a>

                <div class="nav-label">Finance</div>
                <a href="./reports.html" class="sidebar-nav-item">
                    <i class="fas fa-file-invoice"></i><span>Reports</span>
                </a>
                <a href="./coupons.html" class="sidebar-nav-item">
                    <i class="fas fa-tags"></i><span>Coupons</span>
                </a>

                <div class="nav-label">System</div>
                <a href="./audit-logs.html" class="sidebar-nav-item active">
                    <i class="fas fa-history"></i><span>Audit Logs</span>
                </a>
                <a href="./settings.html" class="sidebar-nav-item">
                    <i class="fas fa-cog"></i><span>Settings</span>
                </a>

                <div class="mt-auto">
                    <button id="logoutBtn" class="sidebar-nav-item text-danger border-0 bg-transparent w-100 text-start">
                        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
                    </button>
                </div>
            </nav>
        </aside>

        <main class="dashboard-main">
            
            <header class="dashboard-header d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0">System Activity Logs</h1>
                <div class="dashboard-actions d-flex gap-2">
                    <button class="btn btn-light rounded-circle" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        
                        <div class="p-3 border-bottom d-flex gap-2 bg-light">
                            <input type="text" id="searchLog" class="form-control form-control-sm" placeholder="Search logs (e.g. DELETE)..." style="max-width: 300px;">
                        </div>

                        <div id="logsTable">
                            <div class="p-5 text-center text-muted">
                                <div class="spinner-border spinner-border-sm mb-2"></div>
                                <p>Fetching activity logs...</p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="../../js/config/supabase.js"></script>
    <script src="../../js/config/constants.js"></script>

    <script src="../../js/core/auth.js"></script>
    <script src="../../js/core/theme.js"></script>

    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/utils/date-utils.js"></script>
    <script src="../../js/utils/toast.js"></script>

    <script src="../../js/components/loader.js"></script>
    
    <script src="../../js/dashboards/admin.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Theme & Logout
            document.getElementById('themeToggle')?.addEventListener('click', () => window.theme.toggleTheme());
            document.getElementById('logoutBtn')?.addEventListener('click', () => window.auth.signOut());

            // Load Data
            loadAuditLogs();

            // Search
            document.getElementById('searchLog')?.addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#logsTable tbody tr');
                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });
        });

        async function loadAuditLogs() {
            const container = document.getElementById('logsTable');
            
            try {
                // Fetch logs with user details
                const { data, error } = await window.supabase
                    .from('audit_logs')
                    .select(`
                        *,
                        user:profiles(full_name, role)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50); // Limit to last 50 for performance

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = `<div class="p-5 text-center text-muted">No activity recorded yet.</div>`;
                    return;
                }

                const rows = data.map(log => {
                    // Color code actions
                    let badgeClass = 'bg-secondary';
                    if (log.action.includes('INSERT') || log.action.includes('CREATE')) badgeClass = 'bg-success';
                    if (log.action.includes('UPDATE')) badgeClass = 'bg-warning text-dark';
                    if (log.action.includes('DELETE')) badgeClass = 'bg-danger';

                    return `
                        <tr>
                            <td>
                                <span class="badge ${badgeClass}">${log.action}</span>
                            </td>
                            <td>
                                <div class="fw-medium text-capitalize">${log.table_name.replace(/_/g, ' ')}</div>
                                <small class="text-muted font-monospace">ID: ${log.record_id || '-'}</small>
                            </td>
                            <td>
                                <div>${log.user?.full_name || 'System'}</div>
                                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">${log.user?.role || 'BOT'}</small>
                            </td>
                            <td title="${window.dateUtils.formatDisplayDate(log.created_at)}">
                                ${window.dateUtils.getRelativeTime(log.created_at)}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-light" 
                                    onclick='alert("Changes: " + JSON.stringify(${JSON.stringify(log.changes || {})}, null, 2))'>
                                    <i class="fas fa-code"></i> Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                container.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Performed By</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;

            } catch (error) {
                console.error("Load Error:", error);
                // Graceful fallback if table doesn't exist yet
                container.innerHTML = `
                    <div class="alert alert-warning m-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Could not load logs. Ensure 'audit_logs' table exists.
                    </div>`;
            }
        }
    </script>
</body>
</html>