<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Admin Dashboard</title>

    <link rel="icon" href="../../assets/images/logo/logo.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="../../css/reset.css">
    <link rel="stylesheet" href="../../css/variables.css">
    <link rel="stylesheet" href="../../css/base.css">
    <link rel="stylesheet" href="../../css/layout.css">
    <link rel="stylesheet" href="../../css/components.css">
    <link rel="stylesheet" href="../../css/dashboards.css">
    <link rel="stylesheet" href="../../css/themes.css">
    <link rel="stylesheet" href="../../css/utilities.css">
</head>

<body>
    <div class="dashboard-container">

        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <a href="../../index.html" class="sidebar-logo text-decoration-none">
                    <img src="../../assets/images/logo/logo.png" alt="Logo">
                    <span class="text-white ms-2">Admin Panel</span>
                </a>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-label">Overview</div>
                <a href="./index.html" class="sidebar-nav-item">
                    <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
                </a>
                <a href="./analytics.html" class="sidebar-nav-item active">
                    <i class="fas fa-chart-line"></i><span>Analytics</span>
                </a>

                <div class="nav-label">Management</div>
                <a href="./appointments.html" class="sidebar-nav-item">
                    <i class="fas fa-calendar-check"></i><span>Appointments</span>
                </a>
                <a href="./doctors.html" class="sidebar-nav-item">
                    <i class="fas fa-user-md"></i><span>Doctors</span>
                </a>
                <a href="./tests.html" class="sidebar-nav-item">
                    <i class="fas fa-microscope"></i><span>Lab Tests</span>
                </a>
                <a href="./users.html" class="sidebar-nav-item">
                    <i class="fas fa-users"></i><span>Patients</span>
                </a>

                <div class="nav-label">Finance</div>
                <a href="./reports.html" class="sidebar-nav-item">
                    <i class="fas fa-file-invoice"></i><span>Reports</span>
                </a>
                <a href="./coupons.html" class="sidebar-nav-item">
                    <i class="fas fa-tags"></i><span>Coupons</span>
                </a>

                <div class="nav-label">System</div>
                <a href="./audit-logs.html" class="sidebar-nav-item">
                    <i class="fas fa-history"></i><span>Audit Logs</span>
                </a>
                <a href="./settings.html" class="sidebar-nav-item">
                    <i class="fas fa-cog"></i><span>Settings</span>
                </a>

                <div class="mt-auto">
                    <button id="logoutBtn" class="sidebar-nav-item text-danger border-0 bg-transparent w-100 text-start">
                        <i class="fas fa-sign-out-alt"></i><span>Logout</span>
                    </button>
                </div>
            </nav>
        </aside>

        <main class="dashboard-main">
            
            <header class="dashboard-header d-flex justify-content-between align-items-center mb-4">
                <h1 class="h4 mb-0">Business Intelligence</h1>
                <div class="dashboard-actions d-flex gap-2">
                    <select class="form-select form-select-sm" id="timeRange" style="width: 150px;">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                    </select>
                    
                    <button class="btn btn-light rounded-circle" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <div class="dashboard-content">
                
                <div class="row g-4 mb-4" id="kpiStats">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small mb-2">Total Revenue</h6>
                                <h3 class="mb-0" id="totalRevenue">--</h3>
                                <small class="text-success"><i class="fas fa-arrow-up"></i> (Period)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small mb-2">Appointments</h6>
                                <h3 class="mb-0" id="totalAppts">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small mb-2">Completion Rate</h6>
                                <h3 class="mb-0" id="completionRate">--%</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small mb-2">Active Patients</h6>
                                <h3 class="mb-0" id="activePatients">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-lg-8 mb-4 mb-lg-0">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3">
                                <h5 class="card-title mb-0">Revenue Trend</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="revenueChart" style="height: 350px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3">
                                <h5 class="card-title mb-0">Bookings by Status</h5>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div style="width: 100%; height: 300px;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-4 mb-lg-0">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3">
                                <h5 class="card-title mb-0">Top Performing Doctors</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="topDoctorsChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3">
                                <h5 class="card-title mb-0">Daily Appointments Volume</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="appointmentsChart" style="height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="../../js/config/supabase.js"></script>
    <script src="../../js/config/constants.js"></script>

    <script src="../../js/core/auth.js"></script>
    <script src="../../js/core/theme.js"></script>

    <script src="../../js/utils/helpers.js"></script>
    <script src="../../js/utils/date-utils.js"></script>
    <script src="../../js/utils/toast.js"></script>

    <script src="../../js/components/loader.js"></script>
    <script src="../../js/components/analytics.js"></script>

    <script src="../../js/dashboards/admin.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Theme & Logout
            document.getElementById('themeToggle')?.addEventListener('click', () => window.theme.toggleTheme());
            document.getElementById('logoutBtn')?.addEventListener('click', () => window.auth.signOut());

            // Initial Load (Last 30 Days)
            await refreshAnalytics(30);

            // Handle Range Change
            document.getElementById('timeRange').addEventListener('change', (e) => {
                refreshAnalytics(parseInt(e.target.value));
            });
        });

        async function refreshAnalytics(days) {
            // Calculate Dates
            const endDate = window.dateUtils.getTodayDate();
            const startDate = window.dateUtils.getDateAfterDays(-days);

            // Using the exposed methods from analytics.js
            // 1. Appointment Stats (Donut)
            const statusData = await window.analytics.getAppointmentStats(startDate, endDate);
            if(statusData.success) {
                window.analytics.createStatusChart('statusChart', statusData.stats);
                
                // Update KPI Cards manually
                document.getElementById('totalAppts').innerText = statusData.stats.total;
                const rate = statusData.stats.total > 0 
                    ? Math.round((statusData.stats.completed / statusData.stats.total) * 100) 
                    : 0;
                document.getElementById('completionRate').innerText = `${rate}%`;
            }

            // 2. Revenue (Line Chart)
            const revenueData = await window.analytics.getRevenueByDate(startDate, endDate);
            if(revenueData.success) {
                window.analytics.createRevenueChart('revenueChart', revenueData);
                // Sum total revenue
                const totalRev = revenueData.values.reduce((a, b) => a + b, 0);
                document.getElementById('totalRevenue').innerText = window.helpers.formatCurrency(totalRev);
            }

            // 3. Appointments Volume (Line Chart)
            const volumeData = await window.analytics.getAppointmentsByDate(startDate, endDate);
            if(volumeData.success) {
                window.analytics.createAppointmentsChart('appointmentsChart', volumeData);
            }

            // 4. Top Doctors (Bar Chart)
            const doctorData = await window.analytics.getPopularDoctors(5);
            if(doctorData.success) {
                window.analytics.createTopDoctorsChart('topDoctorsChart', doctorData.doctors);
            }
            
            // 5. Active Patients (KPI)
            const patientData = await window.analytics.getTotalPatients();
            if(patientData.success) {
                document.getElementById('activePatients').innerText = patientData.count;
            }
        }
    </script>
</body>
</html>